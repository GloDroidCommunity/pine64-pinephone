From 3806f15d590cc3fd5d8629f2af543a490fa567da Mon Sep 17 00:00:00 2001
From: Roman Stratiienko <r.stratiienko@gmail.com>
Date: Thu, 23 Nov 2023 02:33:37 +0200
Subject: [PATCH 3/5] bootscript: Swap operation order of images load and AVB
 verification

To make AVB use preloaded images instead of loading them, which
reduces a boot time.

To make it work, a uboot patch that adds a preloaded callback is required.

Signed-off-by: Roman Stratiienko <r.stratiienko@gmail.com>
---
 platform/uboot/bootscript.cpp | 11 ++++++-----
 1 file changed, 6 insertions(+), 5 deletions(-)

diff --git a/platform/uboot/bootscript.cpp b/platform/uboot/bootscript.cpp
index ff216a4..dc1ffeb 100644
--- a/platform/uboot/bootscript.cpp
+++ b/platform/uboot/bootscript.cpp
@@ -155,6 +155,12 @@ FUNC_BEGIN(bootcmd_block)
  DEVICE_HANDLE_BUTTONS()
 #endif
  run bootcmd_bcb
+
+ abootimg load mmc \$mmc_bootdev boot        \${slot_name}
+ abootimg load mmc \$mmc_bootdev init_boot   \${slot_name}
+ abootimg load mmc \$mmc_bootdev vendor_boot \${slot_name}
+ abootimg load mmc \$mmc_bootdev dtbo        \${slot_name}
+
  if test STRESC(\$androidrecovery) = STRESC("true");
  then
   /* Always unlock device for fastbootd and recovery modes, otherwise fastbootd flashing won't work. TODO: Support conditional lock/unlock */
@@ -162,11 +168,6 @@ FUNC_BEGIN(bootcmd_block)
  else
   run bootcmd_avb;
  fi;
-
- abootimg load mmc \$mmc_bootdev boot        \$slot_name
- abootimg load mmc \$mmc_bootdev init_boot   \$slot_name
- abootimg load mmc \$mmc_bootdev vendor_boot \$slot_name
- abootimg load mmc \$mmc_bootdev dtbo        \$slot_name
 FUNC_END()
 
 FUNC_BEGIN(rename_and_expand_userdata_placeholder)
-- 
2.39.2

