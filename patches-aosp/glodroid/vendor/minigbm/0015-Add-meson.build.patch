From 2d5639082e5466c0bc1cac1298c55bb2a2a65d3e Mon Sep 17 00:00:00 2001
From: Roman Stratiienko <r.stratiienko@gmail.com>
Date: Sat, 17 Dec 2022 19:44:49 +0200
Subject: [PATCH 15/19] Add meson.build

Change-Id: I5d5cb9948206b15e833ff63a7dccd2b1002c8cf3
Signed-off-by: Roman Stratiienko <r.stratiienko@gmail.com>

For reviews, comments, suggestions and questions visit:
https://github.com/GloDroid/glodroid_forks/pull/10
---
 cros_gralloc/gralloc0/meson.build | 10 ++++
 cros_gralloc/gralloc4/meson.build | 38 +++++++++++++++
 cros_gralloc/meson.build          | 16 ++++++
 gbm_mesa_driver/meson.build       | 11 +++++
 meson.build                       | 81 +++++++++++++++++++++++++++++++
 5 files changed, 156 insertions(+)
 create mode 100644 cros_gralloc/gralloc0/meson.build
 create mode 100644 cros_gralloc/gralloc4/meson.build
 create mode 100644 cros_gralloc/meson.build
 create mode 100644 gbm_mesa_driver/meson.build
 create mode 100644 meson.build

diff --git a/cros_gralloc/gralloc0/meson.build b/cros_gralloc/gralloc0/meson.build
new file mode 100644
index 0000000..6c45399
--- /dev/null
+++ b/cros_gralloc/gralloc0/meson.build
@@ -0,0 +1,10 @@
+# gralloc0
+shared_library(
+    'gralloc.minigbm_gd',
+    files('gralloc0.cc'),
+    link_with : libminigbm_gralloc,
+    name_prefix : '',
+    dependencies : deps,
+    install : true,
+    install_dir : get_option('libdir') / 'hw',
+)
diff --git a/cros_gralloc/gralloc4/meson.build b/cros_gralloc/gralloc4/meson.build
new file mode 100644
index 0000000..925ec05
--- /dev/null
+++ b/cros_gralloc/gralloc4/meson.build
@@ -0,0 +1,38 @@
+src_allocator4 = files(
+    'CrosGralloc4Allocator.cc',
+    'CrosGralloc4AllocatorService.cc',
+    'CrosGralloc4Utils.cc',
+)
+
+src_mapper4 = files(
+    'CrosGralloc4Mapper.cc',
+    'CrosGralloc4Utils.cc',
+)
+
+shared_library(
+    'android.hardware.graphics.mapper@4.0-impl.minigbm_gd',
+    src_mapper4,
+    link_with : libminigbm_gralloc,
+    name_prefix : '',
+    dependencies : deps,
+    include_directories: inc_include,
+    install : true,
+    install_dir : get_option('libdir') / 'hw',
+)
+
+executable(
+    'android.hardware.graphics.allocator@4.0-service.minigbm_gd',
+    src_allocator4,
+    link_with : libminigbm_gralloc,
+    dependencies : deps,
+    include_directories: inc_include,
+    install : true,
+    install_dir : get_option('bindir') / 'hw',
+)
+
+configure_file(
+    input: 'android.hardware.graphics.allocator@4.0-service.minigbm.rc',
+    output: '@PLAINNAME@',
+    copy: true,
+    install_dir: get_option('sysconfdir') / 'init',
+)
diff --git a/cros_gralloc/meson.build b/cros_gralloc/meson.build
new file mode 100644
index 0000000..ffd2d4c
--- /dev/null
+++ b/cros_gralloc/meson.build
@@ -0,0 +1,16 @@
+src_minigbm_gralloc = files(
+    'cros_gralloc_buffer.cc',
+    'cros_gralloc_driver.cc',
+    'cros_gralloc_helpers.cc',
+)
+
+libminigbm_gralloc = shared_library(
+    'minigbm_gralloc_gd',
+    src_minigbm_gralloc,
+    link_whole: libminigbm,
+    cpp_args: '-DHAS_DMABUF_SYSTEM_HEAP',
+    install : true,
+)
+
+subdir('gralloc0')
+subdir('gralloc4')
diff --git a/gbm_mesa_driver/meson.build b/gbm_mesa_driver/meson.build
new file mode 100644
index 0000000..eb90841
--- /dev/null
+++ b/gbm_mesa_driver/meson.build
@@ -0,0 +1,11 @@
+
+src_gbm_mesa_driver = files(
+    'gbm_mesa_driver.cpp',
+    'gbm_mesa_internals.cpp',
+)
+
+shared_library(
+    'gbm_mesa_wrapper',
+    files('gbm_mesa_wrapper.c'),
+    install : true,
+)
diff --git a/meson.build b/meson.build
new file mode 100644
index 0000000..351c71a
--- /dev/null
+++ b/meson.build
@@ -0,0 +1,81 @@
+project(
+    'minigbm',
+    ['c', 'cpp'],
+    license : 'BSD?',
+    meson_version : '>= 0.56',
+    default_options : ['buildtype=debugoptimized', 'b_ndebug=if-release', 'c_std=c11', 'cpp_std=c++17', 'cpp_rtti=false']
+)
+
+inc_include = [include_directories('.')]
+
+cpu_family = host_machine.cpu_family()
+
+deps = [
+    dependency('cutils'),
+    dependency('drm'),
+    dependency('hardware'),
+    dependency('hidlbase'),
+    dependency('log'),
+]
+
+src_x86 = files(
+    'amdgpu.c',
+    'i915.c',
+)
+
+src_arm = files(
+    'rockchip.c',
+    'msm.c',
+    'vc4.c',
+    'mediatek.c',
+)
+
+src_minigbm = files(
+    'drv_array_helpers.c',
+    'drv_helpers.c',
+    'minigbm_helpers.c',
+    'virtgpu.c',
+    'virtgpu_virgl.c',
+    'dri.c',
+    'drv.c',
+    'virtgpu_cross_domain.c',
+    'dmabuf_driver/dmabuf_external_driver.cpp',
+    'dmabuf_driver/dmabuf_internals.cpp',
+)
+
+c_flags = [
+    '-DDRV_DMABUF_HEAP',
+    '-DDRV_GBM_MESA',
+]
+
+if cpu_family == 'x86' or cpu_family == 'x86_64'
+    src_minigbm += src_x86
+    c_flags += [
+        '-DDRV_AMDGPU',
+        '-DDRV_I915',
+        '-DDRV_RADEON',
+    ]
+elif cpu_family == 'arm' or cpu_family == 'aarch64'
+    src_minigbm += src_arm
+    c_flags += [
+#        '-DDRV_MEDIATEK', # require custom libdrm
+        '-DDRV_MESON',
+        '-DDRV_MSM',
+#        '-DDRV_ROCKCHIP', # require custom libdrm
+#        '-DDRV_VC4', # vc4 looks verey dumb, gbm_mesa should work better
+    ]
+elif
+    error('CPU family not supported')
+endif
+
+subdir('gbm_mesa_driver')
+
+libminigbm = static_library(
+    'minigbm',
+    src_minigbm + src_gbm_mesa_driver,
+    c_args : c_flags,
+    cpp_args : c_flags,
+    dependencies : deps,
+)
+
+subdir('cros_gralloc')
-- 
2.39.2

